# Tempo Distributed Helm Chart Values
# Chart Version: 1.56.0
# App Version: 2.9.0

# Global configuration
global:
  image:
    registry: docker.io
  clusterDomain: cluster.local

# Tempo image configuration
tempo:
  image:
    repository: grafana/tempo
    tag: "2.9.0"
    pullPolicy: IfNotPresent

# MinIO configuration (for development)
minio:
  enabled: true
  replicas: 1
  persistence:
    enabled: true
    size: 30Gi
  resources:
    requests:
      cpu: 100m
      memory: 256Mi
    limits:
      cpu: 500m
      memory: 512Mi
  buckets:
    - name: tempo-traces
      policy: none
      purge: false

# Gateway configuration
gateway:
  enabled: true
  replicas: 2
  image:
    repository: nginx
    tag: "1.25-alpine"
  resources:
    requests:
      cpu: 50m
      memory: 64Mi
    limits:
      cpu: 200m
      memory: 128Mi
  service:
    type: ClusterIP
    port: 80

# Distributor configuration
distributor:
  replicas: 3
  resources:
    requests:
      cpu: 500m
      memory: 1Gi
    limits:
      cpu: 1000m
      memory: 2Gi
  autoscaling:
    enabled: true
    minReplicas: 3
    maxReplicas: 10
    targetCPUUtilizationPercentage: 70
    targetMemoryUtilizationPercentage: 80
  config:
    log_received_spans:
      enabled: true
      include_all_attributes: false
      filter_by_status_error: true

# Ingester configuration
ingester:
  replicas: 3
  resources:
    requests:
      cpu: 1000m
      memory: 4Gi
    limits:
      cpu: 2000m
      memory: 8Gi
  persistence:
    enabled: true
    size: 20Gi
    storageClass: ""
  zoneAwareReplication:
    enabled: true
  affinity:
    podAntiAffinity:
      requiredDuringSchedulingIgnoredDuringExecution:
        - labelSelector:
            matchExpressions:
              - key: app.kubernetes.io/component
                operator: In
                values:
                  - ingester
          topologyKey: kubernetes.io/hostname

# Querier configuration
querier:
  replicas: 3
  resources:
    requests:
      cpu: 500m
      memory: 2Gi
    limits:
      cpu: 1000m
      memory: 4Gi
  autoscaling:
    enabled: true
    minReplicas: 3
    maxReplicas: 8
    targetCPUUtilizationPercentage: 70

# Query Frontend configuration
queryFrontend:
  replicas: 2
  resources:
    requests:
      cpu: 200m
      memory: 512Mi
    limits:
      cpu: 500m
      memory: 1Gi
  config:
    max_retries: 2
    search:
      concurrent_jobs: 1000
      target_bytes_per_job: 104857600
    trace_by_id:
      query_shards: 50
      hedge_requests_at: 2s
      hedge_requests_up_to: 2

# Compactor configuration
compactor:
  replicas: 1
  resources:
    requests:
      cpu: 500m
      memory: 2Gi
    limits:
      cpu: 1000m
      memory: 4Gi
  config:
    compaction:
      block_retention: 720h # 30 days
      compacted_block_retention: 1h
      compaction_window: 1h
      max_block_bytes: 107374182400 # 100GB
      max_compaction_objects: 6000000
      retention_concurrency: 10

# Metrics Generator configuration
metricsGenerator:
  enabled: true
  replicas: 2
  resources:
    requests:
      cpu: 200m
      memory: 512Mi
    limits:
      cpu: 500m
      memory: 1Gi
  config:
    registry:
      collection_interval: 15s
      external_labels: {}
      stale_duration: 15m
    storage:
      path: /var/tempo/wal
      remote_write:
        - url: http://mimir-nginx:80/api/v1/push
          send_exemplars: true
          headers:
            X-Scope-OrgID: tempo-metrics
      remote_write_flush_deadline: 1m
    processor:
      span_metrics:
        histogram_buckets: [0.002, 0.005, 0.01, 0.025, 0.05, 0.1, 0.25, 0.5, 1, 2.5, 5, 10]
        dimensions:
          - http.method
          - http.target
          - http.status_code
          - service.version
          - span.kind
        intrinsic_dimensions:
          service: true
          span_name: true
          span_kind: true
          status_code: true
      service_graphs:
        histogram_buckets: [0.1, 0.2, 0.4, 0.8, 1.6, 3.2, 6.4, 12.8]
        dimensions:
          - http.method
          - http.target
          - http.status_code
          - service.version
        peer_attributes:
          - db.name
          - db.operation

# Memcached configuration
memcached:
  enabled: true
  image:
    repository: memcached
    tag: "1.6.22-alpine"

# Memcached chunks
memcachedChunks:
  enabled: true
  replicas: 2
  allocatedMemory: 2048
  maxItemMemory: 10
  resources:
    requests:
      cpu: 100m
      memory: 512Mi
    limits:
      cpu: 200m
      memory: 1Gi

# Memcached frontend
memcachedFrontend:
  enabled: true
  replicas: 2
  allocatedMemory: 1024
  maxItemMemory: 5
  resources:
    requests:
      cpu: 100m
      memory: 256Mi
    limits:
      cpu: 200m
      memory: 512Mi

# Memcached index queries
memcachedIndexQueries:
  enabled: true
  replicas: 2
  allocatedMemory: 1024
  maxItemMemory: 5
  resources:
    requests:
      cpu: 100m
      memory: 256Mi
    limits:
      cpu: 200m
      memory: 512Mi

# Storage configuration
storage:
  trace:
    backend: s3
    s3:
      bucket: tempo-traces
      endpoint: minio:9000
      access_key: minioadmin
      secret_key: minioadmin123
      insecure: true
      # For production, use proper S3 configuration:
      # region: us-east-1
      # access_key: ${AWS_ACCESS_KEY_ID}
      # secret_key: ${AWS_SECRET_ACCESS_KEY}

# Traces configuration
traces:
  otlp:
    grpc:
      enabled: true
      receiverConfig:
        endpoint: 0.0.0.0:4317
    http:
      enabled: true
      receiverConfig:
        endpoint: 0.0.0.0:4318
  jaeger:
    grpc:
      enabled: true
      receiverConfig:
        endpoint: 0.0.0.0:14250
    thriftBinary:
      enabled: true
      receiverConfig:
        endpoint: 0.0.0.0:6832
    thriftCompact:
      enabled: true
      receiverConfig:
        endpoint: 0.0.0.0:6831
    thriftHttp:
      enabled: true
      receiverConfig:
        endpoint: 0.0.0.0:14268
  zipkin:
    enabled: true
    receiverConfig:
      endpoint: 0.0.0.0:9411

# Global overrides
global_overrides:
  max_traces_per_user: 1000000
  max_bytes_per_trace: 50000000
  ingestion_rate_limit_bytes: 150000000
  ingestion_burst_size_bytes: 300000000
  metrics_generator_processors:
    - service-graphs
    - span-metrics
    - local-blocks

# Tempo configuration
config: |
  # Multitenancy
  multitenancy_enabled: false
  
  # Server configuration
  server:
    http_listen_port: 3200
    grpc_listen_port: 9095
    log_level: info
    log_format: logfmt
  
  # Distributor configuration
  distributor:
    receivers:
      otlp:
        protocols:
          grpc:
            endpoint: 0.0.0.0:4317
          http:
            endpoint: 0.0.0.0:4318
      jaeger:
        protocols:
          grpc:
            endpoint: 0.0.0.0:14250
          thrift_binary:
            endpoint: 0.0.0.0:6832
          thrift_compact:
            endpoint: 0.0.0.0:6831
          thrift_http:
            endpoint: 0.0.0.0:14268
      zipkin:
        endpoint: 0.0.0.0:9411
    ring:
      kvstore:
        store: memberlist
  
  # Ingester configuration
  ingester:
    lifecycler:
      ring:
        kvstore:
          store: memberlist
        replication_factor: 3
      tokens_file_path: /var/tempo/tokens.json
    trace_idle_period: 10s
    max_block_bytes: 1048576
    max_block_duration: 5m
  
  # Storage configuration
  storage:
    trace:
      backend: s3
      s3:
        bucket: tempo-traces
        endpoint: minio:9000
        access_key: minioadmin
        secret_key: minioadmin123
        insecure: true
      pool:
        max_workers: 100
        queue_depth: 10000
  
  # Compactor configuration
  compactor:
    ring:
      kvstore:
        store: memberlist
    compaction:
      block_retention: 720h
      compacted_block_retention: 1h
      compaction_window: 1h
      max_compaction_objects: 6000000
      max_block_bytes: 107374182400
      retention_concurrency: 10
  
  # Query frontend configuration
  query_frontend:
    search:
      concurrent_jobs: 1000
      target_bytes_per_job: 104857600
    trace_by_id:
      query_shards: 50
      hedge_requests_at: 2s
      hedge_requests_up_to: 2
    results_cache:
      cache:
        memcached_client:
          addresses: {{ include "tempo.memcachedFrontendFullname" . }}:11211
  
  # Querier configuration
  querier:
    max_concurrent_queries: 20
    search:
      query_timeout: 30s
    trace_by_id:
      query_timeout: 10s
    frontend_worker:
      frontend_address: {{ include "tempo.queryFrontendFullname" . }}:9095
  
  # Memberlist configuration
  memberlist:
    abort_if_cluster_join_fails: false
    bind_port: 7946
    join_members:
      - {{ include "tempo.fullname" . }}-gossip-ring

# Service Monitor for Prometheus scraping
serviceMonitor:
  enabled: true
  labels:
    app: tempo
  interval: 30s
  scrapeTimeout: 30s

# Service account
serviceAccount:
  create: true
  name: tempo
  annotations: {}

# RBAC
rbac:
  create: true

# Pod disruption budget
podDisruptionBudget:
  enabled: true
  minAvailable: 1

# Network policy
networkPolicy:
  enabled: false