# Loki Helm Chart Values
# Chart Version: 6.46.0
# App Version: 3.5.7

# Global configuration
global:
  image:
    registry: docker.io
  clusterDomain: cluster.local

# Loki image configuration
loki:
  image:
    repository: grafana/loki
    tag: "3.5.7"
    pullPolicy: IfNotPresent

# Deployment mode (Distributed for production)
deploymentMode: Distributed

# Test configuration
test:
  enabled: false

# Loki canary
lokiCanary:
  enabled: false

# MinIO configuration (for development)
minio:
  enabled: true
  replicas: 1
  persistence:
    enabled: true
    size: 30Gi
  resources:
    requests:
      cpu: 100m
      memory: 256Mi
    limits:
      cpu: 500m
      memory: 512Mi
  buckets:
    - name: loki-chunks
      policy: none
      purge: false
    - name: loki-ruler
      policy: none
      purge: false
    - name: loki-admin
      policy: none
      purge: false

# Gateway configuration
gateway:
  enabled: true
  replicas: 2
  image:
    repository: nginx
    tag: "1.25-alpine"
  resources:
    requests:
      cpu: 50m
      memory: 64Mi
    limits:
      cpu: 200m
      memory: 128Mi
  service:
    type: ClusterIP
    port: 80
  nginxConfig:
    logFormat: |-
      main '$remote_addr - $remote_user [$time_local]  $status '
            '"$request" $body_bytes_sent "$http_referer" '
            '"$http_user_agent" "$http_x_forwarded_for"';

# Distributor configuration
distributor:
  replicas: 3
  resources:
    requests:
      cpu: 500m
      memory: 1Gi
    limits:
      cpu: 1000m
      memory: 2Gi
  autoscaling:
    enabled: true
    minReplicas: 3
    maxReplicas: 10
    targetCPUUtilizationPercentage: 70
    targetMemoryUtilizationPercentage: 80
  maxUnavailable: 1

# Ingester configuration
ingester:
  replicas: 3
  resources:
    requests:
      cpu: 1000m
      memory: 4Gi
    limits:
      cpu: 2000m
      memory: 8Gi
  persistence:
    enabled: true
    size: 20Gi
    storageClass: ""
  zoneAwareReplication:
    enabled: true
  affinity:
    podAntiAffinity:
      requiredDuringSchedulingIgnoredDuringExecution:
        - labelSelector:
            matchExpressions:
              - key: app.kubernetes.io/component
                operator: In
                values:
                  - ingester
          topologyKey: kubernetes.io/hostname

# Querier configuration
querier:
  replicas: 3
  resources:
    requests:
      cpu: 500m
      memory: 2Gi
    limits:
      cpu: 1000m
      memory: 4Gi
  autoscaling:
    enabled: true
    minReplicas: 3
    maxReplicas: 8
    targetCPUUtilizationPercentage: 70
  maxUnavailable: 2

# Query Frontend configuration
queryFrontend:
  replicas: 2
  resources:
    requests:
      cpu: 200m
      memory: 512Mi
    limits:
      cpu: 500m
      memory: 1Gi
  maxUnavailable: 1

# Query Scheduler configuration
queryScheduler:
  replicas: 2
  resources:
    requests:
      cpu: 100m
      memory: 256Mi
    limits:
      cpu: 200m
      memory: 512Mi

# Index Gateway configuration
indexGateway:
  replicas: 2
  resources:
    requests:
      cpu: 200m
      memory: 512Mi
    limits:
      cpu: 500m
      memory: 1Gi
  persistence:
    enabled: true
    size: 10Gi
  maxUnavailable: 1

# Compactor configuration
compactor:
  replicas: 1
  resources:
    requests:
      cpu: 500m
      memory: 2Gi
    limits:
      cpu: 1000m
      memory: 4Gi
  persistence:
    enabled: true
    size: 10Gi

# Ruler configuration
ruler:
  enabled: true
  replicas: 2
  resources:
    requests:
      cpu: 200m
      memory: 512Mi
    limits:
      cpu: 500m
      memory: 1Gi
  persistence:
    enabled: true
    size: 5Gi

# Bloom Compactor (disabled for now)
bloomCompactor:
  replicas: 0

# Bloom Gateway (disabled for now)
bloomGateway:
  replicas: 0

# Backend (disabled in distributed mode)
backend:
  replicas: 0

# Read (disabled in distributed mode)
read:
  replicas: 0

# Write (disabled in distributed mode)
write:
  replicas: 0

# Single Binary (disabled in distributed mode)
singleBinary:
  replicas: 0

# Memcached configuration
memcached:
  image:
    repository: memcached
    tag: "1.6.22-alpine"

# Memcached chunks
memcachedChunks:
  enabled: true
  replicas: 2
  allocatedMemory: 2048
  maxItemMemory: 10
  resources:
    requests:
      cpu: 100m
      memory: 512Mi
    limits:
      cpu: 200m
      memory: 1Gi

# Memcached frontend
memcachedFrontend:
  enabled: true
  replicas: 2
  allocatedMemory: 1024
  maxItemMemory: 5
  resources:
    requests:
      cpu: 100m
      memory: 256Mi
    limits:
      cpu: 200m
      memory: 512Mi

# Memcached index queries
memcachedIndexQueries:
  enabled: true
  replicas: 2
  allocatedMemory: 1024
  maxItemMemory: 5
  resources:
    requests:
      cpu: 100m
      memory: 256Mi
    limits:
      cpu: 200m
      memory: 512Mi

# Memcached index writes
memcachedIndexWrites:
  enabled: true
  replicas: 2
  allocatedMemory: 1024
  maxItemMemory: 5
  resources:
    requests:
      cpu: 100m
      memory: 256Mi
    limits:
      cpu: 200m
      memory: 512Mi

# Loki configuration
loki:
  # Authentication
  auth_enabled: false
  
  # Server configuration
  server:
    http_listen_port: 3100
    grpc_listen_port: 9095
    log_level: info
    log_format: logfmt
    http_server_read_timeout: 600s
    http_server_write_timeout: 600s
  
  # Common configuration
  common:
    compactor_address: http://loki-compactor:3100
    path_prefix: /var/loki
    replication_factor: 3
    storage:
      s3:
        endpoint: minio:9000
        bucketnames: loki-chunks
        access_key_id: minioadmin
        secret_access_key: minioadmin123
        insecure: true
        s3forcepathstyle: true
        # For production, use proper S3 configuration:
        # region: us-east-1
        # access_key_id: ${AWS_ACCESS_KEY_ID}
        # secret_access_key: ${AWS_SECRET_ACCESS_KEY}
  
  # Memberlist configuration
  memberlist:
    join_members:
      - loki-memberlist
  
  # Limits configuration
  limits_config:
    ingestion_rate_mb: 50
    ingestion_burst_size_mb: 100
    max_query_parallelism: 32
    max_query_series: 10000
    max_query_lookback: 720h
    max_streams_per_user: 0
    max_line_size: 256KB
    max_entries_limit_per_query: 10000
    max_cache_freshness_per_query: 10m
    reject_old_samples: true
    reject_old_samples_max_age: 168h
    retention_period: 720h # 30 days
    split_queries_by_interval: 24h
    volume_enabled: true
    allow_structured_metadata: true
  
  # Storage configuration
  storage_config:
    tsdb_shipper:
      active_index_directory: /var/loki/tsdb-index
      cache_location: /var/loki/tsdb-cache
    aws:
      s3: s3://loki-chunks
      bucketnames: loki-chunks
      endpoint: minio:9000
      access_key_id: minioadmin
      secret_access_key: minioadmin123
      insecure: true
      s3forcepathstyle: true
  
  # Schema configuration
  schema_config:
    configs:
      - from: 2024-01-01
        store: tsdb
        object_store: s3
        schema: v13
        index:
          prefix: loki_index_
          period: 24h
  
  # Ruler configuration
  ruler:
    enable_api: true
    enable_alertmanager_v2: true
    alertmanager_url: http://mimir-nginx:80/alertmanager
    storage:
      type: s3
      s3:
        bucketnames: loki-ruler
        endpoint: minio:9000
        access_key_id: minioadmin
        secret_access_key: minioadmin123
        insecure: true
        s3forcepathstyle: true
    rule_path: /tmp/loki/rules
    ring:
      kvstore:
        store: memberlist
  
  # Distributor configuration
  distributor:
    ring:
      kvstore:
        store: memberlist
  
  # Ingester configuration
  ingester:
    lifecycler:
      ring:
        kvstore:
          store: memberlist
        replication_factor: 3
      tokens_file_path: /var/loki/tokens.json
    chunk_encoding: snappy
    chunk_idle_period: 30m
    chunk_retain_period: 1m
    max_chunk_age: 1h
    chunk_target_size: 1536000
    chunk_block_size: 262144
    flush_check_period: 30s
    flush_op_timeout: 10s
  
  # Query range configuration
  query_range:
    align_queries_with_step: true
    cache_results: true
    max_retries: 5
    parallelise_shardable_queries: true
    results_cache:
      cache:
        memcached_client:
          addresses: loki-memcached-frontend:11211
          timeout: 500ms
          max_idle_conns: 16
  
  # Frontend configuration
  frontend:
    log_queries_longer_than: 5s
    compress_responses: true
    max_outstanding_per_tenant: 2048
    scheduler_address: loki-query-scheduler:9095
  
  # Frontend worker configuration
  frontend_worker:
    scheduler_address: loki-query-scheduler:9095
    match_max_concurrent: true
  
  # Querier configuration
  querier:
    max_concurrent: 16
    query_timeout: 300s
    tail_max_duration: 1h
    extra_query_delay: 0s
  
  # Query scheduler configuration
  query_scheduler:
    max_outstanding_requests_per_tenant: 32768
  
  # Index gateway configuration
  index_gateway:
    mode: ring
    ring:
      kvstore:
        store: memberlist
  
  # Compactor configuration
  compactor:
    working_directory: /var/loki/compactor
    shared_store: s3
    compaction_interval: 10m
    retention_enabled: true
    retention_delete_delay: 2h
    retention_delete_worker_count: 150
    delete_request_cancel_period: 24h
  
  # Analytics configuration
  analytics:
    reporting_enabled: false
  
  # Tracing configuration
  tracing:
    enabled: false

# Service Monitor for Prometheus scraping
serviceMonitor:
  enabled: true
  labels:
    app: loki
  interval: 30s
  scrapeTimeout: 30s
  namespaceSelector: {}
  targetLabels: []
  metricRelabelings: []

# Service account
serviceAccount:
  create: true
  name: loki
  annotations: {}
  automountServiceAccountToken: true

# RBAC
rbac:
  create: true
  pspEnabled: false

# Network policy
networkPolicy:
  enabled: false

# Pod security policy
podSecurityPolicy:
  enabled: false