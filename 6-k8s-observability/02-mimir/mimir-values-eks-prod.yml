# Mimir Distributed Helm Chart Values for EKS Production
# Chart Version: 6.0.3
# App Version: 3.0.0
# Cluster: EKS Production
# Domain: spicybiryaniwala.shop

# Global configuration
global:
  image:
    registry: docker.io
  clusterDomain: cluster.local
  extraArgs:
    - -config.expand-env=true
  extraEnv:
    - name: MY_POD_IP
      valueFrom:
        fieldRef:
          fieldPath: status.podIP
    - name: AWS_REGION
      value: us-east-1
    - name: S3_BUCKET_BLOCKS
      value: spicy-mimir-blocks-prod
    - name: S3_BUCKET_RULER
      value: spicy-mimir-ruler-prod
    - name: S3_BUCKET_ALERTMANAGER
      value: spicy-mimir-alertmanager-prod

# Mimir image configuration
image:
  repository: grafana/mimir
  tag: "3.0.0"
  pullPolicy: IfNotPresent

# MinIO disabled for production (using S3)
minio:
  enabled: false

# Nginx gateway for production
nginx:
  enabled: true
  replicas: 3
  image:
    repository: nginx
    tag: "1.25-alpine"
  resources:
    requests:
      cpu: 100m
      memory: 128Mi
    limits:
      cpu: 500m
      memory: 256Mi
  service:
    type: ClusterIP
    port: 80
    annotations:
      service.beta.kubernetes.io/aws-load-balancer-type: nlb
  basicAuth:
    enabled: true
    username: observe
    password: SpicyBiryani2024!
  ingress:
    enabled: true
    ingressClassName: nginx
    annotations:
      cert-manager.io/cluster-issuer: letsencrypt-prod
      nginx.ingress.kubernetes.io/ssl-redirect: "true"
      nginx.ingress.kubernetes.io/force-ssl-redirect: "true"
      nginx.ingress.kubernetes.io/rate-limit: "1000"
      nginx.ingress.kubernetes.io/rate-limit-window: "1m"
    hosts:
      - host: mimir.spicybiryaniwala.shop
        paths:
          - path: /
            pathType: Prefix
    tls:
      - secretName: mimir-tls
        hosts:
          - mimir.spicybiryaniwala.shop

# Distributor configuration for production
distributor:
  replicas: 5
  resources:
    requests:
      cpu: 1000m
      memory: 2Gi
    limits:
      cpu: 2000m
      memory: 4Gi
  autoscaling:
    enabled: true
    minReplicas: 5
    maxReplicas: 15
    targetCPUUtilizationPercentage: 70
    targetMemoryUtilizationPercentage: 80
  nodeSelector:
    node-type: monitoring
    kubernetes.io/arch: amd64
  tolerations:
    - key: workloadType
      operator: Equal
      value: monitoring
      effect: NoSchedule

# Ingester configuration for production
ingester:
  replicas: 6
  resources:
    requests:
      cpu: 2000m
      memory: 8Gi
    limits:
      cpu: 4000m
      memory: 16Gi
  persistentVolume:
    enabled: true
    size: 50Gi
    storageClass: gp3
  zoneAwareReplication:
    enabled: true
  affinity:
    podAntiAffinity:
      requiredDuringSchedulingIgnoredDuringExecution:
        - labelSelector:
            matchExpressions:
              - key: app.kubernetes.io/component
                operator: In
                values:
                  - ingester
          topologyKey: kubernetes.io/hostname
  nodeSelector:
    node-type: monitoring
    kubernetes.io/arch: amd64
  tolerations:
    - key: workloadType
      operator: Equal
      value: monitoring
      effect: NoSchedule

# Querier configuration for production
querier:
  replicas: 6
  resources:
    requests:
      cpu: 1000m
      memory: 4Gi
    limits:
      cpu: 2000m
      memory: 8Gi
  autoscaling:
    enabled: true
    minReplicas: 6
    maxReplicas: 12
    targetCPUUtilizationPercentage: 70
  nodeSelector:
    node-type: monitoring
    kubernetes.io/arch: amd64
  tolerations:
    - key: workloadType
      operator: Equal
      value: monitoring
      effect: NoSchedule

# Query Frontend configuration
query_frontend:
  replicas: 3
  resources:
    requests:
      cpu: 500m
      memory: 1Gi
    limits:
      cpu: 1000m
      memory: 2Gi
  nodeSelector:
    node-type: monitoring
    kubernetes.io/arch: amd64
  tolerations:
    - key: workloadType
      operator: Equal
      value: monitoring
      effect: NoSchedule

# Query Scheduler configuration
query_scheduler:
  enabled: true
  replicas: 3
  resources:
    requests:
      cpu: 200m
      memory: 512Mi
    limits:
      cpu: 500m
      memory: 1Gi
  nodeSelector:
    node-type: monitoring
    kubernetes.io/arch: amd64
  tolerations:
    - key: workloadType
      operator: Equal
      value: monitoring
      effect: NoSchedule

# Store Gateway configuration for production
store_gateway:
  replicas: 6
  resources:
    requests:
      cpu: 1000m
      memory: 4Gi
    limits:
      cpu: 2000m
      memory: 8Gi
  persistentVolume:
    enabled: true
    size: 20Gi
    storageClass: gp3
  zoneAwareReplication:
    enabled: true
  affinity:
    podAntiAffinity:
      preferredDuringSchedulingIgnoredDuringExecution:
        - weight: 100
          podAffinityTerm:
            labelSelector:
              matchExpressions:
                - key: app.kubernetes.io/component
                  operator: In
                  values:
                    - store-gateway
            topologyKey: kubernetes.io/hostname
  nodeSelector:
    node-type: monitoring
    kubernetes.io/arch: amd64
  tolerations:
    - key: workloadType
      operator: Equal
      value: monitoring
      effect: NoSchedule

# Compactor configuration
compactor:
  replicas: 2
  resources:
    requests:
      cpu: 1000m
      memory: 4Gi
    limits:
      cpu: 2000m
      memory: 8Gi
  persistentVolume:
    enabled: true
    size: 50Gi
    storageClass: gp3
  nodeSelector:
    node-type: monitoring
    kubernetes.io/arch: amd64
  tolerations:
    - key: workloadType
      operator: Equal
      value: monitoring
      effect: NoSchedule

# Ruler configuration
ruler:
  enabled: true
  replicas: 3
  resources:
    requests:
      cpu: 500m
      memory: 1Gi
    limits:
      cpu: 1000m
      memory: 2Gi
  nodeSelector:
    node-type: monitoring
    kubernetes.io/arch: amd64
  tolerations:
    - key: workloadType
      operator: Equal
      value: monitoring
      effect: NoSchedule

# Alertmanager configuration
alertmanager:
  enabled: true
  replicas: 3
  resources:
    requests:
      cpu: 200m
      memory: 512Mi
    limits:
      cpu: 500m
      memory: 1Gi
  persistentVolume:
    enabled: true
    size: 10Gi
    storageClass: gp3
  statefulSet:
    enabled: true
  nodeSelector:
    node-type: monitoring
    kubernetes.io/arch: amd64
  tolerations:
    - key: workloadType
      operator: Equal
      value: monitoring
      effect: NoSchedule

# Overrides Exporter
overrides_exporter:
  enabled: true
  replicas: 1
  resources:
    requests:
      cpu: 100m
      memory: 128Mi
    limits:
      cpu: 200m
      memory: 256Mi

# Memcached configuration for production
memcached:
  enabled: true
  image:
    repository: memcached
    tag: "1.6.22-alpine"

# Results cache - production sizing
results-cache:
  enabled: true
  replicas: 3
  allocatedMemory: 2048
  maxItemMemory: 10
  resources:
    requests:
      cpu: 200m
      memory: 512Mi
    limits:
      cpu: 500m
      memory: 1Gi

# Chunks cache - production sizing
chunks-cache:
  enabled: true
  replicas: 3
  allocatedMemory: 4096
  maxItemMemory: 20
  resources:
    requests:
      cpu: 200m
      memory: 1Gi
    limits:
      cpu: 500m
      memory: 2Gi

# Index cache - production sizing
index-cache:
  enabled: true
  replicas: 3
  allocatedMemory: 2048
  maxItemMemory: 10
  resources:
    requests:
      cpu: 200m
      memory: 512Mi
    limits:
      cpu: 500m
      memory: 1Gi

# Metadata cache - production sizing
metadata-cache:
  enabled: true
  replicas: 3
  allocatedMemory: 1024
  maxItemMemory: 5
  resources:
    requests:
      cpu: 100m
      memory: 256Mi
    limits:
      cpu: 200m
      memory: 512Mi

# Mimir configuration for EKS production
mimir:
  config: |
    # Multitenancy enabled for production
    multitenancy_enabled: true
    
    # Server configuration
    server:
      http_listen_port: 8080
      grpc_listen_port: 9095
      grpc_server_max_recv_msg_size: 104857600
      grpc_server_max_send_msg_size: 104857600
      grpc_server_max_concurrent_streams: 1000
      log_level: info
      log_format: logfmt
    
    # Distributor configuration for production
    distributor:
      ring:
        kvstore:
          store: memberlist
      instance_limits:
        max_ingestion_rate: 500000
        max_inflight_push_requests: 5000
      ha_tracker:
        enable_ha_tracker: true
        kvstore:
          store: memberlist
    
    # Ingester configuration for production
    ingester:
      ring:
        kvstore:
          store: memberlist
        replication_factor: 3
        tokens_file_path: /data/tokens
        zone_awareness_enabled: true
        final_sleep: 0s
        num_tokens: 512
        unregister_on_shutdown: false
    
    # Blocks storage configuration with S3
    blocks_storage:
      backend: s3
      s3:
        region: us-east-1
        bucket_name: ${S3_BUCKET_BLOCKS}
        endpoint: ""
      tsdb:
        dir: /data/tsdb
        retention_period: 90d
      bucket_store:
        sync_dir: /data/tsdb-sync
        chunks_cache:
          backend: memcached
          memcached:
            addresses: {{ include "mimir.chunksCacheAddress" . }}
            max_item_size: {{ mul (index .Values "chunks-cache").maxItemMemory 1024 1024 }}
            timeout: 450ms
            max_idle_connections: 150
        index_cache:
          backend: memcached
          memcached:
            addresses: {{ include "mimir.indexCacheAddress" . }}
            max_item_size: {{ mul (index .Values "index-cache").maxItemMemory 1024 1024 }}
            max_idle_connections: 150
        metadata_cache:
          backend: memcached
          memcached:
            addresses: {{ include "mimir.metadataCacheAddress" . }}
            max_item_size: {{ mul (index .Values "metadata-cache").maxItemMemory 1024 1024 }}
            max_idle_connections: 150
    
    # Compactor configuration for production
    compactor:
      data_dir: /data
      sharding_ring:
        kvstore:
          store: memberlist
        wait_stability_min_duration: 1m
      compaction_interval: 30m
      deletion_delay: 2h
      max_closing_blocks_concurrency: 4
      max_opening_blocks_concurrency: 8
      symbols_flushers_concurrency: 8
    
    # Store gateway configuration
    store_gateway:
      sharding_ring:
        kvstore:
          store: memberlist
        replication_factor: 3
        zone_awareness_enabled: true
        wait_stability_min_duration: 1m
    
    # Query frontend configuration
    frontend:
      results_cache:
        backend: memcached
        memcached:
          addresses: {{ include "mimir.resultsCacheAddress" . }}
          max_item_size: {{ mul (index .Values "results-cache").maxItemMemory 1024 1024 }}
          timeout: 500ms
      cache_results: true
      log_queries_longer_than: 1m
      parallelize_shardable_queries: true
      scheduler_address: {{ template "mimir.fullname" . }}-query-scheduler-headless.{{ .Release.Namespace }}.svc:{{ include "mimir.serverGrpcListenPort" . }}
    
    # Frontend worker configuration
    frontend_worker:
      scheduler_address: {{ template "mimir.fullname" . }}-query-scheduler-headless.{{ .Release.Namespace }}.svc:{{ include "mimir.serverGrpcListenPort" . }}
      grpc_client_config:
        max_send_msg_size: 419430400
    
    # Querier configuration for production
    querier:
      max_concurrent: 32
      max_fetched_chunks_per_query: 8000000
    
    # Query scheduler configuration
    query_scheduler:
      max_outstanding_requests_per_tenant: 1600
    
    # Ruler configuration
    ruler:
      enable_api: true
      rule_path: /data
      alertmanager_url: dnssrvnoa+http://_http-metrics._tcp.{{ template "mimir.fullname" . }}-alertmanager-headless.{{ .Release.Namespace }}.svc.{{ .Values.global.clusterDomain }}/alertmanager
    
    # Ruler storage configuration with S3
    ruler_storage:
      backend: s3
      s3:
        region: us-east-1
        bucket_name: ${S3_BUCKET_RULER}
        endpoint: ""
    
    # Alertmanager configuration
    alertmanager:
      data_dir: /data
      enable_api: true
      external_url: /alertmanager
      fallback_config_file: /configs/alertmanager_fallback_config.yaml
    
    # Alertmanager storage configuration with S3
    alertmanager_storage:
      backend: s3
      s3:
        region: us-east-1
        bucket_name: ${S3_BUCKET_ALERTMANAGER}
        endpoint: ""
    
    # Production limits configuration
    limits:
      ingestion_rate: 500000
      ingestion_burst_size: 1000000
      max_global_series_per_user: 20000000
      max_global_series_per_metric: 100000
      max_label_names_per_series: 120
      max_label_name_length: 1024
      max_label_value_length: 4096
      max_metadata_length: 1024
      out_of_order_time_window: 1h
      compactor_blocks_retention_period: 90d
      accept_ha_samples: true
      ha_cluster_label: cluster
      ruler_max_rules_per_rule_group: 100
      ruler_max_rule_groups_per_tenant: 500
    
    # Memberlist configuration
    memberlist:
      abort_if_cluster_join_fails: false
      bind_port: 7946
      bind_addr:
        - ${MY_POD_IP}
      join_members:
        - {{ include "mimir.fullname" . }}-gossip-ring
      cluster_label: "{{ include "mimir.fullname" . }}-gossip-ring.{{ .Release.Namespace }}.svc.{{ .Values.global.clusterDomain }}"
      cluster_label_verification_disabled: true
      compression_enabled: false
    
    # Runtime config
    runtime_config:
      file: /var/{{ include "mimir.name" . }}/runtime.yaml

# Runtime configuration for production
runtimeConfig:
  ingester_limits:
    max_inflight_push_requests: 5000
    max_ingestion_rate: 500000
    max_series: 20000000

# Service Monitor for Prometheus scraping
metaMonitoring:
  serviceMonitor:
    enabled: true
    labels:
      app: mimir
      release: monitor
    interval: 30s
    scrapeTimeout: 30s
    clusterLabel: eks-prod

# RBAC configuration
rbac:
  type: scc
  create: true

# Service account with EKS IAM role
serviceAccount:
  create: true
  name: mimir
  annotations:
    eks.amazonaws.com/role-arn: arn:aws:iam::123456789012:role/mimir-eks-role
  automountServiceAccountToken: true

# Pod disruption budgets for high availability
podDisruptionBudget:
  distributor:
    enabled: true
    minAvailable: 3
  ingester:
    enabled: true
    minAvailable: 4
  querier:
    enabled: true
    minAvailable: 4
  query_frontend:
    enabled: true
    minAvailable: 2
  store_gateway:
    enabled: true
    minAvailable: 4